services:
  # Your Node.js application service
  app:
    # Use a lightweight official Node.js image
    image: node:20-alpine
    container_name: dev_app
    working_dir: /app

    # Mount your project code into the container
    volumes:
      # Mounts the current directory (host) to /app (container)
      - .:/app
      # Uses a named volume for node_modules to avoid host/container conflicts
      - app_node_modules:/app/node_modules
    
    ports:
      # Expose your app's port. 
      # Change "3000" if your npm run dev serves on a different port.
      - "3000:3000"
      
    # Command to run on start: install dependencies, then start the dev server
    command: sh -c "npm install && npm run dev"
    
    environment:
      # Pass environment variables to your Node.js app
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # This pulls the password from your .env file
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NODE_ENV=development
      
    # Ensures the 'redis' service starts before the 'app' service
    depends_on:
      - redis
      
    # Connects this service to our custom network
    networks:
      - dev_network

  # Your Redis service (based on your snippet)
  redis:
    image: redis/redis-stack-server:latest
    container_name: dev_redis
    ports:
      # Port for your app to connect to Redis
      - "6379:6379"
      # Port for the RedisInsight GUI (super helpful for dev)
      - "8001:8001"
      
    # Use the password from the .env file
    command: redis-stack-server --requirepass ${REDIS_PASSWORD}
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
    volumes:
      # Persists Redis data across container restarts
      - redis_data:/data
      
    networks:
      - dev_network

# Define the network for services to communicate
networks:
  dev_network:
    driver: bridge

# Define the named volumes for data persistence
volumes:
  redis_data:
  app_node_modules: # Volume for the app's node_modules